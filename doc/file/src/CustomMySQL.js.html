<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/CustomMySQL.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/anyTV/anytv-node-mysql.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Connection.js~Connection.html">Connection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/CustomMySQL.js~CustomMySQL.html">CustomMySQL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Query.js~Query.html">Query</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Transaction.js~Transaction.html">Transaction</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/CustomMySQL.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import Transaction from &apos;./Transaction&apos;;
import Connection from &apos;./Connection&apos;;
import Query from &apos;./Query&apos;;
import mysql from &apos;mysql&apos;;

/**
 * This is my class description
 */
export default class CustomMySQL {

    constructor () {
        this.escape = mysql.escape;
        this._logger = console;
        this._max_retry = 3;
    }


    set_logger (logger) {
        this._logger = logger || console;
        return this;
    }

    set_max_retry (max) {
        this._max_retry = max || 3;
        return this;
    }


    add (key, config, is_pool) {
        if (!key || !config) {
            throw new Error(&apos;key or config is missing&apos;);
        }

        if (typeof key !== &apos;string&apos;) {
            throw new Error(&apos;key should be a string&apos;);
        }

        if (typeof config !== &apos;object&apos;) {
            throw new Error(&apos;config should be an object&apos;);
        }

        this._key = key;
        this[key] = {config};
        this[key].is_pool = !!is_pool;

        if (is_pool) {
            new Connection(this);
        }

        return this;
    }

    retry_if (retryable_errors) {
        this.retryable_errors = retryable_errors;
        return this;
    }

    use (key) {
        if (!key) {
            throw new Error(&apos;key is missing&apos;);
        }

        if (!this[key]) {
            throw new Error(&apos;Key does not exist. Add a connection first by using mysql.add(key, config, is_pool)&apos;);
        }

        this._key = key;
        this.retryable_errors = null;

        if (!this.is_pool &amp;&amp; this.current_connection) {
            this.end();
        }

        return this;
    }

    args () {
        if (!this._key) {
            throw new Error(&apos;Key does not exist. Add a connection first by using mysql.add(key, config, is_pool)&apos;);
        }

        this._args = arguments;
        return this;
    }

    query () {
        if (!this._key) {
            throw new Error(&apos;Key does not exist. Add a connection first by using mysql.add(key, config, is_pool)&apos;);
        }

        if (arguments.length &lt; 2) {
            throw new Error(&apos;Incomplete arguments. Have at least a query and a callback&apos;);
        }

        if (typeof arguments[0] !== &apos;string&apos;) {
            throw new Error(&apos;Query is not a string&apos;);
        }

        if (typeof arguments[arguments.length - 1] !== &apos;function&apos;) {
            throw new Error(&apos;Last parameter is not a function&apos;);
        }

        new Query(this, ...arguments);
        return this;
    }

    transaction () {
        if (!this.current_connection) {
            new Connection(this);
        }

        return new Transaction(this);
    }

    end () {
        if (this._key &amp;&amp; !this[this._key].is_pool &amp;&amp; this[this._key].connection) {
            this[this._key].connection.end();
            this.current_connection = null;
            this[this._key].connection = null;
        }

        return this;
    }



    /* Everything below will be deprecated */

    open (config) {
        let self = this,
            config_str = &apos;&apos;,
            i;


        for (i in config) {
            config_str += config[i];
        }


        this._key = config_str;

        if (this[config_str] &amp;&amp; this[config_str].connection) {
            return this;
        }

        this[config_str] = {
            config,
            is_pool: true,
            connection: mysql.createPool(config)
        };

        this[config_str].connection.on(&apos;error&apos;, function (err) {
            console.log(&apos;error&apos;, err);
        });

        this[config_str].connection.on(&apos;close&apos;, function (err) {
            console.log(&apos;close&apos;, err);
            self[config_str].connection = mysql.createPool(self[config_str].config);
        });

        this.escapeId = this[config_str].connection.escapeId.bind(this[config_str].connection);

        return this;
    }

    async (query, args, async_args, collector, fn) {
        let results = [];
        let len = args.length;

        function _collector (err, result, _args) {
            let temp = {
                err: err,
                result: result,
                args: _args
            };

            results.push(
                collector
                ? collector(err, result, _args)
               : temp
            );

            if (!--len) {
                fn(async_args || results);
            }
        }

        if (arguments.length === 4) {
            fn = collector;
            collector = async_args;
            async_args = null;
        }

        if (arguments.length === 3) {
            fn = async_args;
            async_args = null;
        }

        args.forEach((arg, index) =&gt; {
            this.args(async_args &amp;&amp; async_args.hasOwnProperty(index)
                    ? async_args[index]
                   : arg
                )
                .query(query, arg, _collector);
        });

        return this;
    }

    on (_event, cb) {
        if (!this._key) {
            throw new Error(&apos;Key does not exist. Add a connection first by using mysql.add(key, config, is_pool)&apos;);
        }

        return this[this._key].connection.on(_event, cb);
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
